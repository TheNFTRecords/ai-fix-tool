<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI検出“補正”ツール｜簡易版（補正A/B/C）</title>
  <style>
    :root { --bg:#0b0d10; --panel:#141820; --ink:#e6ebf2; --muted:#8a95a7; --accent:#5eead4; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b0d10,#0e1218);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{padding:18px 20px;border-bottom:1px solid #1f2633;background:#0d1117;position:sticky;top:0;z-index:3}
    header h1{margin:0;font-size:16px;letter-spacing:.3px}
    .wrap{display:grid;grid-template-columns:300px 1fr;gap:16px;padding:16px}
    .panel{background:var(--panel);border:1px solid #1f2633;border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.2)}
    .panel h2{margin:0;padding:12px 14px;border-bottom:1px solid #1f2633;font-size:14px;color:#c9d4e3}
    .panel .body{padding:12px 14px}
    .row{display:flex;align-items:center;gap:8px;margin:10px 0}
    label{min-width:110px;color:#cbd5e1;font-size:12px}
    input[type="file"],button{background:#0f1420;color:var(--ink);border:1px solid #283146;border-radius:10px;padding:10px;font-size:13px}
    .muted{color:var(--muted);font-size:12px}
    .footer{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
    .danger{border-color:#7f1d1d;color:#fecaca}
    .accent{border-color:#1f6f6a;background:#0b1f1d;color:#99f6e4}
    canvas{width:100%;height:auto;background:#0b0d10;border-bottom-left-radius:16px;border-bottom-right-radius:16px}
  </style>
</head>
<body>
  <header>
    <h1>AI検出“補正”ツール（簡易版｜補正A/B/Cのみ）</h1>
  </header>
  <div class="wrap">
    <!-- 左ペイン：設定 -->
    <section class="panel">
      <h2>設定</h2>
      <div class="body">
        <div class="row">
          <label>元画像</label>
          <input id="baseInput" type="file" accept="image/*" />
        </div>
        <div class="row">
          <label>補正パターン</label>
          <div>
            <div class="row" style="margin:6px 0"><input type="radio" name="preset" id="presetA" value="A" checked> <label for="presetA" style="min-width:auto">補正A</label></div>
            <div class="row" style="margin:6px 0"><input type="radio" name="preset" id="presetB" value="B"> <label for="presetB" style="min-width:auto">補正B</label></div>
            <div class="row" style="margin:6px 0"><input type="radio" name="preset" id="presetC" value="C"> <label for="presetC" style="min-width:auto">補正C</label></div>
          </div>
        </div>
        <div class="muted">※ 補正はブラウザ内のみで適用され、ファイルはサーバーへ送信されません。</div>
        <div class="footer">
          <button id="exportPng" class="accent">PNG書き出し</button>
          <button id="exportJpg">JPG書き出し</button>
          <button id="clear" class="danger">画像クリア</button>
        </div>
      </div>
    </section>

    <!-- 右ペイン：プレビュー -->
    <section class="panel">
      <h2>プレビュー</h2>
      <canvas id="canvas"></canvas>
      <div class="body">
        <div class="muted">処理はすべてローカルで行われます。ファイルはサーバーに送信されません。</div>
      </div>
    </section>
  </div>

  <script>
    const MAX_SIDE = 4096;
    const baseInput = document.getElementById('baseInput');
    const exportPngBtn = document.getElementById('exportPng');
    const exportJpgBtn = document.getElementById('exportJpg');
    const clearBtn = document.getElementById('clear');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const presetRadios = Array.from(document.querySelectorAll('input[name="preset"]'));

    // 非公開アセットの読み込み先（例）
    // 実運用では認証付き配信やビルド時埋め込みを推奨（クライアントのみでは秘匿は不可能）。
    const OVERLAY_SRC = {
      A: 'assets/overlay_a.png',
      B: 'assets/overlay_b.png',
      C: 'assets/overlay_c.png'
    };

    // 各補正の固定パラメータ（UIでの変更不可）
    const PRESETS = {
      A: { alpha: 0.30, blend: 'soft-light', tile: true, rotateDeg: 0, scale: 1.0 },
      B: { alpha: 0.26, blend: 'overlay',    tile: true, rotateDeg: 0, scale: 1.0 },
      C: { alpha: 0.22, blend: 'multiply',   tile: true, rotateDeg: 0, scale: 1.0 }
    };

    let baseImage = null;
    let overlays = {};
    let currentPreset = 'A';

    function loadImageFromFile(file) {
      return new Promise((resolve, reject) => {
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.onload = () => resolve({img, url});
        img.onerror = reject;
        img.src = url;
      });
    }

    function loadImageFromURL(url){
      return new Promise((resolve, reject)=>{
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = url;
      });
    }

    async function setBaseFromFile(file){
      const {img, url} = await loadImageFromFile(file);
      baseImage = img;
      const {w, h} = fitWithin(img.naturalWidth, img.naturalHeight, MAX_SIDE);
      canvas.width = w; canvas.height = h;
      draw();
      URL.revokeObjectURL(url);
    }

    function fitWithin(w, h, maxSide){
      if (Math.max(w,h) <= maxSide) return {w, h};
      const s = maxSide / Math.max(w,h);
      return {w: Math.round(w*s), h: Math.round(h*s)};
    }

    function draw(){
      ctx.clearRect(0,0,canvas.width, canvas.height);
      if (!baseImage){
        ctx.fillStyle = '#0b0d10';
        ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = '#2c3a53';
        ctx.font = '14px ui-monospace, SFMono-Regular, Menlo, monospace';
        ctx.fillText('ここに画像を読み込み', 16, 28);
        return;
      }
      const iw = baseImage.naturalWidth, ih = baseImage.naturalHeight;
      const {w, h} = fitWithin(iw, ih, MAX_SIDE);
      canvas.width = w; canvas.height = h;
      ctx.drawImage(baseImage, 0, 0, w, h);

      const ovImg = overlays[currentPreset];
      const cfg = PRESETS[currentPreset];
      if (!ovImg || !cfg) return;

      ctx.save();
      ctx.globalAlpha = cfg.alpha;
      ctx.globalCompositeOperation = cfg.blend;

      const scale = cfg.scale;
      const rot = (cfg.rotateDeg || 0) * Math.PI/180;

      if (cfg.tile){
        const tw = ovImg.naturalWidth * scale;
        const th = ovImg.naturalHeight * scale;
        for(let y = 0; y < h + th; y += th){
          for(let x = 0; x < w + tw; x += tw){
            ctx.save();
            ctx.translate(x + tw/2, y + th/2);
            ctx.rotate(rot);
            ctx.drawImage(ovImg, -tw/2, -th/2, tw, th);
            ctx.restore();
          }
        }
      } else {
        const tw = ovImg.naturalWidth * scale;
        const th = ovImg.naturalHeight * scale;
        ctx.translate(w/2, h/2);
        ctx.rotate(rot);
        ctx.drawImage(ovImg, -tw/2, -th/2, tw, th);
      }
      ctx.restore();
    }

    // イベント
    baseInput.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0];
      if (f) await setBaseFromFile(f);
    });

    presetRadios.forEach(r=> r.addEventListener('change', ()=>{
      currentPreset = presetRadios.find(x=>x.checked)?.value || 'A';
      draw();
    }));

    exportPngBtn.addEventListener('click', ()=> downloadCanvas('image/png'));
    exportJpgBtn.addEventListener('click', ()=> downloadCanvas('image/jpeg', 0.95));

    clearBtn.addEventListener('click', ()=>{
      baseImage = null; ctx.clearRect(0,0,canvas.width,canvas.height);
    });

    function downloadCanvas(mime, quality){
      if (!baseImage){ alert('先に元画像を読み込んでください'); return; }
      const url = canvas.toDataURL(mime, quality);
      const a = document.createElement('a');
      const ext = mime==='image/png'?'png':'jpg';
      a.download = `processed_${Date.now()}.${ext}`;
      a.href = url; a.click();
    }

    // 初期プレースホルダー
    canvas.width = 1024; canvas.height = 1024; draw();

    // ドラッグ&ドロップ（元画像）
    document.addEventListener('dragover', e=>{ e.preventDefault(); });
    document.addEventListener('drop', e=>{
      e.preventDefault();
      const files = Array.from(e.dataTransfer.files || []);
      if (!files.length) return;
      const img = files.find(f=> f.type.startsWith('image/'));
      if (img) setBaseFromFile(img);
    });

    // 手続き的テクスチャを使用するためプリロードは不要です。
    
  </script>
</body>
</html>
